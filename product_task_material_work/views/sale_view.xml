<?xml version="1.0" encoding="UTF-8"?>
<odoo>
   
    <record model="ir.ui.view" id="view_sale_order_form_inherit">
        <field name="name">sale.order.form.inherit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="before">
                <field name="ref"/>
            </xpath>

            <xpath expr="//field[@name='client_order_ref']" position="replace">
                
            </xpath>

            <xpath expr="//field[@name='analytic_account_id']" position="replace">
            
            </xpath>

            <xpath expr="//field[@name='partner_invoice_id']" position="before">
                <field name="client_order_ref"/>
            </xpath>

            <xpath expr="//field[@name='payment_term_id']" position="after">
                <!--<field name="account_analytic_group_id" groups="analytic.group_analytic_accounting" />-->
                <field name="analytic_account_id" context="{'default_partner_id':partner_invoice_id, 'default_name':name}" readonly= "invoice_count != 0 and state == 'sale'" groups="analytic.group_analytic_accounting" force_save="1"/>
                <field name="visible_project" invisible="1"/>
                <field name="project_id" options="{'no_create': True}" invisible="not visible_project"/>
            </xpath>

            <xpath expr="//field[@name='validity_date']" position="before">
                <field name="opportunity_id" options="{'no_create': True}" string="Oportunidad / Aviso"/>
            </xpath>

        </field>
    </record>

    <record model="ir.ui.view" id="view_sale_order_project_form_inherit">
        <field name="name">sale.order.project.form.inherit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_project.view_order_form_inherit_sale_project"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='visible_project']" position="replace"/>
            <xpath expr="//field[@name='project_id']" position="replace"/>
        </field>
    </record>

    <record model="ir.ui.view" id="view_sale_order_crm_form_inherit">
        <field name="name">sale.order.crm.form.inherit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_crm.sale_view_inherit123"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='opportunity_id']" position="replace"/>
        </field>
    </record>

    <record model="ir.ui.view" id="view_sale_order_line_form">
        <field name="name">sale.order.form.inherit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='order_line']/tree" position="attributes">
                <attribute name="editable"/>
            </xpath>

            <xpath expr="//field[@name='order_line']/tree/field[@name='invoice_status']" position="attributes">
                <attribute name="column_invisible" eval="False"/>
            </xpath>

            <xpath expr="//field[@name='order_line']/tree/field[@name='qty_to_invoice']" position="attributes">
                <attribute name="column_invisible" eval="False"/>
            </xpath>

            <xpath expr="//field[@name='order_line']/form/group" position="before">
                <group invisible="display_type">
                    <group>
                        <field name="detailed_time"/>
                        <field name="detailed_subtotal_price_time" invisible="not detailed_time"/>
                        <field name="detailed_price_time" invisible="not detailed_time"/>
                    </group>
                    <group>
                        <field name="detailed_materials"/>
                        <field name="detailed_subtotal_price_materials" invisible="not detailed_materials"/>
                        <field name="detailed_price_materials" invisible="not detailed_materials"/>
                    </group>
                </group>
            </xpath>

            <xpath expr="//field[@name='order_line']/form//field[@name='display_type']" position="before">
                <!--<header>
                    <button string="Recalcular" name="product_action_recalculate" type="object" class="oe_highlight" invisible="not auto_create_task"/>
                </header> -->
            </xpath>

            <xpath expr="//field[@name='order_line']/form//field[@name='name']" position="after">
               <field name="auto_create_task" invisible="1"/>
               <div name="partida" attrs="{'invisible':[('auto_create_task','!=',True)]}">
                    <field name="see_works_and_materials"/>
                    <group string="Trabajos" invisible="see_works_and_materials in ['only_materials',False]">
                        
                        <field name="task_works_ids" nolabel="1" context="{'default_product_id': active_id}">
                            <tree string="Trabajos" editable="bottom">
                                <field name="sequence" widget="handle"/>
                                <field name="work_id"/>
                                <field name="name"/>
                                <field name="hours" sum="Horas totales" widget="float_time"/>
                                <field name="cost_price_unit" widget="monetary" optional="show" groups="product_task_material_work.group_sales_product_cost"/>
                                <field name="sale_price_unit" widget="monetary" optional="show"/>
                                <field name="discount" groups="product.group_discount_per_so_line" optional="show"/>
                                <field name="cost_price" widget="monetary" sum="Total P.C." optional="hide" groups="product_task_material_work.group_sales_product_cost"/>
                                <field name="sale_price" widget="monetary" sum="Total P.V." optional="show"/>
                                <field name="work_margin" widget="monetary" groups="product_task_material_work.group_sales_margin" optional="hide"/>
                                <field name="work_margin_percent" optional="show" groups="product_task_material_work.group_sales_margin" widget="percentage"/>
                                <field name="company_id" invisible="0"/>
                                <field name="currency_id" column_invisible="True"/>
                            </tree>
                        </field>
                        <group class="pull-right">
                            <field name="total_sp_work" invisible="1"/>
                            <field name="total_cp_work" invisible="1"/>
                            <field name="total_hours" invisible="1"/>
                            <label for="benefit_work_amount" string="Beneficio" groups="product_task_material_work.group_sales_margin"/>
                            <div>
                                <field name="benefit_work_amount" class="oe_inline" nolabel="1" groups="product_task_material_work.group_sales_margin" widget="monetary"/>
                                <span> | </span>
                                <field name="benefit_work" class="oe_inline" nolabel="1" groups="product_task_material_work.group_sales_margin" widget="percentage"/>
                            </div>
                        </group>
                    </group>
                    <group string="Materiales" invisible="see_works_and_materials in ['only_works',False]">
                        <field name="task_materials_ids" nolabel="1" context="{'default_product_id':active_id}">
                            <tree string="Materiales" editable="bottom">
                                <field name="sequence" widget="handle"/>                                
                                <field name="material_id"/>
                                <field name="name"/>
                                <field name="quantity"/>
                                <field name="cost_price_unit" widget="monetary" optional="show" groups="product_task_material_work.group_sales_product_cost"/>
                                <field name="sale_price_unit" widget="monetary" optional="show"/>
                                <field name="discount" groups="product.group_discount_per_so_line" optional="show"/>
                                <field name="cost_price" widget="monetary" sum="Total P.C." optional="hide" groups="product_task_material_work.group_sales_product_cost"/>
                                <field name="sale_price" widget="monetary" sum="Total P.V." optional="show"/>
                                <field name="material_margin" widget="monetary" groups="product_task_material_work.group_sales_margin" optional="hide"/>
                                <field name="material_margin_percent" optional="show" groups="product_task_material_work.group_sales_margin" widget="percentage"/>
                                <field name="company_id" invisible="0"/>
                                <field name="currency_id" column_invisible="True"/>
                            </tree>
                        </field>
                        <group class="pull-right">
                            <field name="total_sp_material" invisible="1"/>
                            <field name="total_cp_material" invisible="1"/>
                            <label for="benefit_material_amount" string="Beneficio" groups="product_task_material_work.group_sales_margin"/>
                            <div>
                                <field name="benefit_material_amount" class="oe_inline" nolabel="1" groups="product_task_material_work.group_sales_margin" widget="monetary" options="{'currency_field': 'currency_id', 'field_digits': True}"/>
                                <span> | </span>
                                <field name="benefit_material" class="oe_inline" nolabel="1" groups="product_task_material_work.group_sales_margin" widget="percentage"/>
                            </div>
                        </group>
                    </group>
                </div>
                
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="sale_margin_group">
        <field name="name">sale.margin.group.view.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_margin.sale_margin_sale_order"/>
        <field name="arch" type="xml">
            <xpath expr="//label[@for='margin']" position="attributes">
                <attribute name="groups">product_task_material_work.group_sales_margin</attribute>
            </xpath>
            <xpath expr="//div[@class='text-nowrap']" position="attributes">
                <attribute name="groups">product_task_material_work.group_sales_margin</attribute>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="sale_margin_sale_order_line">
        <field name="name">sale.order.line.purchase.view.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_margin.sale_margin_sale_order_line"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='order_line']/form//field[@name='purchase_price']" position="attributes">
                <attribute name="groups">product_task_material_work.group_sales_product_cost</attribute>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="sale_margin_sale_order_line_form">
        <field name="name">sale.order.line.tree.purchase.view.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_margin.sale_margin_sale_order_line_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='order_line']/tree//field[@name='purchase_price']" position="attributes">
                <attribute name="groups">product_task_material_work.group_sales_product_cost</attribute>
            </xpath>
            <xpath expr="//field[@name='order_line']/tree//field[@name='margin']" position="attributes">
                <attribute name="groups">product_task_material_work.group_sales_margin</attribute>
            </xpath>
            <xpath expr="//field[@name='order_line']/tree//field[@name='margin_percent']" position="attributes">
                <attribute name="groups">product_task_material_work.group_sales_margin</attribute>
            </xpath>
        </field>
    </record>

</odoo>
